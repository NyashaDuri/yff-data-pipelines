import os
from time import sleep
import pandas as pd
import http.client

geo_pcon_2021='1929379865,1929379880,1929379885,1929379886,1929379952,1929379969,1929379988,1929380020,1929380044,1929380057,1929380065,1929380076,1929380130,1929380131,1929380142...1929380144,1929380151,1929380164,1929380167,1929380202,1929380226,1929380255,1929380281,1929380282,1929380293,1929380317,1929380325,1929380331,1929379843,1929379848,1929379854,1929379870,1929379881...1929379884,1929379889...1929379892,1929379920,1929379922,1929379923,1929379931,1929379938,1929379948,1929379951,1929379957,1929379958,1929379964,1929379972,1929379997,1929379999,1929380017,1929380019,1929380036,1929380049,1929380058,1929380069,1929380086,1929380087,1929380096,1929380104...1929380107,1929380113,1929380116,1929380118...1929380120,1929380136,1929380181,1929380182,1929380186,1929380188,1929380196,1929380205,1929380208,1929380213,1929380222,1929380227,1929380254,1929380269,1929380273,1929380274,1929380278,1929380280,1929380290,1929380298,1929380321,1929380328,1929380329,1929380335,1929380344,1929380348,1929380350,1929380354,1929380355,1929380364,1929380365,1929380368,1929380370,1929379852,1929379853,1929379859,1929379867,1929379898...1929379900,1929379907,1929379925,1929379954,1929379956,1929379977...1929379980,1929379994,1929380000,1929380027,1929380034,1929380035,1929380041,1929380051,1929380067,1929380077,1929380082...1929380084,1929380088...1929380092,1929380137,1929380147,1929380187,1929380197,1929380206,1929380214,1929380215,1929380224,1929380225,1929380228,1929380230...1929380234,1929380236,1929380239,1929380304,1929380320,1929380339,1929380372,1929380373,1929379844,1929379846,1929379857,1929379888,1929379893,1929379894,1929379918,1929379936,1929379943,1929379959,1929379971,1929379973...1929379975,1929380006,1929380018,1929380021,1929380025,1929380039,1929380059,1929380080,1929380093...1929380095,1929380103,1929380108,1929380109,1929380121,1929380125,1929380140,1929380154,1929380169,1929380172,1929380173,1929380176...1929380178,1929380219,1929380220,1929380235,1929380240,1929380246,1929380250,1929380251,1929380253,1929380336,1929379842,1929379871...1929379879,1929379916,1929379921,1929379929,1929379960...1929379962,1929379982,1929379983,1929380033,1929380054,1929380078,1929380102,1929380110,1929380123,1929380129,1929380145,1929380158,1929380160,1929380165,1929380179,1929380203,1929380216,1929380237,1929380242,1929380256,1929380276,1929380277,1929380283...1929380288,1929380296,1929380297,1929380300,1929380303,1929380322,1929380323,1929380327,1929380330,1929380340,1929380341,1929380346,1929380360...1929380363,1929380369,1929379855,1929379863,1929379901,1929379905,1929379914,1929379917,1929379924,1929379928,1929379933,1929379935,1929379939,1929379953,1929379955,1929380004,1929380028,1929380040,1929380045,1929380050,1929380055,1929380056,1929380060,1929380068,1929380072,1929380111,1929380112,1929380117,1929380124,1929380127,1929380152,1929380153,1929380156,1929380159,1929380166,1929380170,1929380174,1929380175,1929380189,1929380199,1929380210,1929380221,1929380244,1929380245,1929380248,1929380252,1929380257,1929380260,1929380262,1929380263,1929380268,1929380271,1929380279,1929380292,1929380306,1929380332,1929380333,1929380338,1929380345,1929380356,1929379851,1929379860,1929379862,1929379864,1929379866,1929379869,1929379902...1929379904,1929379915,1929379926,1929379932,1929379940,1929379945,1929379947,1929379950,1929379965...1929379968,1929379984...1929379987,1929379990,1929379998,1929380001...1929380003,1929380007,1929380012,1929380014,1929380029,1929380031,1929380032,1929380037,1929380038,1929380042,1929380043,1929380048,1929380052,1929380061...1929380063,1929380070,1929380071,1929380074,1929380075,1929380079,1929380081,1929380098...1929380101,1929380134,1929380180,1929380183,1929380193,1929380198,1929380207,1929380211,1929380217,1929380289,1929380295,1929380309,1929380313,1929380316,1929380318,1929380319,1929380324,1929380343,1929380347,1929380351,1929379841,1929379845,1929379847,1929379849,1929379850,1929379856,1929379861,1929379868,1929379887,1929379897,1929379908,1929379909,1929379919,1929379930,1929379937,1929379942,1929379944,1929379963,1929379970,1929379981,1929379991...1929379993,1929379995,1929379996,1929380005,1929380008,1929380010,1929380011,1929380015,1929380022,1929380024,1929380026,1929380030,1929380046,1929380047,1929380053,1929380064,1929380066,1929380073,1929380097,1929380114,1929380115,1929380122,1929380128,1929380132,1929380133,1929380135,1929380138,1929380139,1929380141,1929380155,1929380163,1929380168,1929380184,1929380185,1929380194,1929380195,1929380200,1929380201,1929380204,1929380209,1929380212,1929380218,1929380229,1929380238,1929380241,1929380259,1929380264,1929380266,1929380267,1929380270,1929380294,1929380308,1929380315,1929380326,1929380334,1929380352,1929380353,1929380357...1929380359,1929380366,1929380367,1929379858,1929379895,1929379896,1929379906,1929379910...1929379913,1929379927,1929379934,1929379941,1929379946,1929379949,1929379976,1929379989,1929380009,1929380013,1929380016,1929380023,1929380085,1929380126,1929380146,1929380148...1929380150,1929380157,1929380161,1929380162,1929380171,1929380190...1929380192,1929380223,1929380243,1929380247,1929380249,1929380258,1929380261,1929380265,1929380272,1929380275,1929380291,1929380299,1929380301,1929380302,1929380305,1929380307,1929380310...1929380312,1929380314,1929380337,1929380342,1929380349,1929380371,1929380374...1929380472'
geo_pcon_2024='721420327,721420332,721420333,721420399,721420409,721420416,721420437,721420470,721420498,721420511,721420521,721420533,721420594,721420593,721420603...721420605,721420608,721420615,721420623,721420666,721420718,721420744,721420745,721420757,721420783,721420793,721420299,721420307,721420309,721420311,721420312,721420315,721420348...721420350,721420363,721420379,721420386,721420393,721420395,721420398,721420401,721420412...721420415,721420431,721420433...721420435,721420439,721420447,721420449,721420451,721420455,721420462,721420464,721420483,721420485,721420486,721420490,721420491,721420496,721420497,721420502,721420505,721420516,721420518,721420519,721420526,721420527,721420531,721420532,721420536,721420538,721420557...721420560,721420597,721420640,721420643,721420647,721420656,721420660,721420661,721420671,721420674,721420680,721420729,721420751,721420753,721420760,721420776,721420779,721420782,721420784,721420785,721420789,721420802,721420812,721420292,721420294,721420305,721420335,721420340,721420366,721420391,721420405,721420418...721420421,721420454,721420469,721420471,721420479,721420492,721420513,721420514,721420537,721420552...721420554,721420562,721420568,721420569,721420581,721420583,721420588,721420590,721420601,721420617,721420630,721420632,721420633,721420636...721420638,721420683,721420684,721420697,721420702,721420709,721420713,721420714,721420716,721420797,721420303,721420310,721420347,721420351,721420362,721420365,721420372,721420375,721420380,721420382,721420385,721420400,721420402,721420432,721420450,721420452,721420482,721420493,721420494,721420499,721420504,721420509,721420510,721420515,721420524,721420528,721420570...721420572,721420577,721420585,721420591,721420610,721420616,721420619,721420622,721420627,721420628,721420631,721420634,721420635,721420651,721420663,721420706,721420707,721420715,721420720,721420722,721420723,721420727,721420728,721420733,721420738,721420742,721420756,721420772,721420794,721420795,721420799,721420804,721420816,721420291,721420296,721420302,721420317,721420328...721420331,721420336...721420339,721420368,721420370,721420371,721420378,721420384,721420389,721420390,721420396,721420404,721420411,721420448,721420468,721420477,721420503,721420512,721420525,721420543,721420544,721420555,721420563...721420567,721420573,721420576,721420578...721420580,721420587,721420598,721420641,721420642,721420648,721420650,721420659,721420669,721420672,721420676,721420681,721420685,721420689,721420717,721420730,721420735,721420736,721420741,721420743,721420754,721420765,721420787,721420790,721420791,721420803,721420806,721420809...721420811,721420815,721420824,721420828,721420921...721420938,721420874...721420881,721420864,721420882,721420865,721420883,721420866,721420884...721420891,721420867,721420892...721420908,721420869,721420909...721420911,721420870,721420912,721420913,721420868,721420871,721420914,721420872,721420915...721420919,721420873,721420920,721420289,721420293,721420295,721420297,721420298,721420304,721420308,721420314,721420316,721420334,721420343,721420355,721420356,721420367,721420377,721420383,721420388,721420392,721420410,721420417,721420423,721420427,721420428,721420436,721420438,721420440...721420442,721420444...721420446,721420453,721420456,721420459...721420461,721420465,721420472,721420475,721420478,721420480,721420484,721420489,721420500,721420501,721420506,721420508,721420520,721420522,721420529,721420530,721420556,721420574,721420575,721420586,721420592,721420595,721420596,721420599,721420600,721420602,721420618,721420629,721420645,721420646,721420657,721420658,721420664,721420665,721420668,721420673,721420675,721420682,721420691,721420700,721420703,721420725,721420726,721420731,721420758,721420759,721420775,721420781,721420796,721420813,721420814,721420817...721420819,721420825,721420826,721420306,721420341,721420342,721420352,721420357...721420361,721420374,721420381,721420387,721420394,721420397,721420443,721420457,721420458,721420463,721420466,721420467,721420473,721420474,721420517,721420582,721420589,721420607,721420611...721420614,721420620,721420625,721420652,721420653,721420655,721420686,721420708,721420710...721420712,721420721,721420724,721420734,721420737,721420755,721420762,721420763,721420766,721420768,721420771,721420774,721420777,721420778,721420780,721420798,721420801,721420807,721420829,721420832...721420863,721420290,721420318...721420326,721420364,721420369,721420376,721420406...721420408,721420429,721420430,721420487,721420507,721420535,721420542,721420561,721420584,721420606,721420621,721420624,721420626,721420639,721420667,721420679,721420699,721420704,721420705,721420719,721420739,721420740,721420746...721420750,721420752,721420761,721420764,721420767,721420769,721420773,721420788,721420792,721420800,721420805,721420820...721420823,721420827,721420300,721420301,721420313,721420344...721420346,721420353,721420354,721420373,721420403,721420422,721420424...721420426,721420476,721420481,721420488,721420495,721420523,721420534,721420539...721420541,721420545...721420551,721420609,721420644,721420649,721420654,721420662,721420670,721420677,721420678,721420687,721420688,721420690,721420692...721420696,721420698,721420701,721420732,721420770,721420786,721420808,721420830,721420831'
geo_pcon=geo_pcon_2021+geo_pcon_2024

date_range='latestMINUS8-latest'

variables = [
  18, 19, 20,
  83, 84, 85, 86,
  110, 111, 112, 113,
  1213,
  1219,
  1493
]

def get_variable(variable, geography):
    url = f'https://www.nomisweb.co.uk/api/v01/dataset/NM_17_5.data.csv?geography={geography}&date={date_range}&variable={variable}&measures=20599,21001,21002,21003'
    retries = 3
    while retries > 0:
        try:
            data = pd.read_csv(url)
            retries = 0
        except http.client.RemoteDisconnected as e:
            retries -= 1
            if retries <=0:
                raise e
            sleep(5)

    if data.index.size == 25000:
        raise RuntimeError('Maxed out request to NOMIS (%d rows)', data.index.size)
    return data

if __name__ == '__main__':
    THIS_DIR = os.path.dirname(__file__)
    print(THIS_DIR)
    data = pd.concat([
            get_variable(variable=v, geography=geo_pcon_2021)
            for v in variables
        ] + [
            get_variable(variable=v, geography=geo_pcon_2024)
            for v in variables
        ], axis=0
    )
    
    DATA_FILE=f'{THIS_DIR}/../../data/raw/lfs_by_pcon.csv'
    os.makedirs(os.path.dirname(DATA_FILE), exist_ok=True)
    data.reset_index().to_csv(DATA_FILE, index=False)